# Easy Translate 开发指南

本文档面向开发者，包含需求分析、设计思路、架构设计和环境配置等内容。

## 📋 需求描述

### 核心需求
**问题**：用户需要将网页上的文件下载到远程服务器时，通常需要经历"下载到本地 → 上传到服务器"的繁琐流程，耗时且效率低。

**解决方案**：开发一个浏览器插件，自动识别网页中的下载链接，提供一键传输到目标服务器的功能，跳过本地下载步骤。

### 功能需求
1. **智能链接识别**：自动检测页面中可下载的文件链接
2. **传输按钮注入**：在下载链接旁动态添加传输按钮
3. **服务器管理**：支持多服务器配置的CRUD操作
4. **传输执行**：支持SFTP/FTP/SCP等协议的文件传输
5. **状态监控**：提供传输进度和历史记录查看
6. **右键菜单**：通过浏览器右键菜单快速发起传输

### 非功能需求
- **性能**：页面加载后1-2秒内完成链接识别
- **兼容性**：支持Edge/Chrome等Chromium浏览器
- **安全性**：本地存储敏感信息，不上传第三方服务器
- **可用性**：简洁直观的用户界面，一键操作
- **稳定性**：异常情况下的降级处理和错误提示

## 🎯 设计思路

### 核心理念
- **简洁高效**：最少的操作步骤实现最大的效率提升
- **用户友好**：智能检测，自动化操作，减少用户学习成本
- **可扩展性**：模块化设计，便于后续功能扩展
- **最小侵入**：不影响原网页功能，仅在需要时显示

### 设计原则
1. **自动检测优于手动选择**：主动识别下载链接而非等待用户指定
2. **视觉提示优于隐藏功能**：直观的按钮提示而非隐藏的右键菜单
3. **配置一次长期使用**：服务器信息持久化存储
4. **优雅降级**：在不支持的环境下提供基础功能

## 🏗️ 架构设计

### 整体架构
```
┌─────────────────────────────────────────────────────────────┐
│                        浏览器环境                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │   Content       │    │   Background    │                │
│  │   Script        │◄──►│   Script        │                │
│  │                 │    │                 │                │
│  │ • 页面注入       │    │ • 传输引擎       │                │
│  │ • 链接识别       │    │ • 右键菜单       │                │
│  │ • UI交互        │    │ • 数据存储       │                │
│  │ • 按钮注入       │    │ • 消息转发       │                │
│  └─────────────────┘    └─────────────────┘                │
│           │                       │                        │
│           └───────────────────────┼─────────────────────   │
│                                   │                        │
├─────────────────────────────────────────────────────────────┤
│                     Chrome Storage API                     │
│               (servers, transferHistory, settings)         │
└─────────────────────────────────────────────────────────────┘
```

### 技术栈选择

#### 前端技术栈
```
┌─────────────────┐
│ Manifest V3     │  ← Chrome Extension API最新版本
├─────────────────┤
│ ES6+ JavaScript │  ← 现代JavaScript语法
├─────────────────┤
│ Tailwind CSS    │  ← 原子化CSS框架
├─────────────────┤
│ DaisyUI         │  ← 基于Tailwind的UI组件库
└─────────────────┘
```

#### 构建工具链
```
┌─────────────────┐
│ Webpack 5       │  ← 模块打包和构建
├─────────────────┤
│ PostCSS         │  ← CSS后处理器
├─────────────────┤
│ CSS Loader      │  ← CSS模块加载
├─────────────────┤
│ Mini CSS Extract│  ← CSS提取插件
└─────────────────┘
```

### 核心模块设计

#### 1. 链接识别模块 (Link Detector)
**职责**：识别页面中的可下载文件链接

**算法设计**：
```javascript
class LinkDetector {
    patterns = [
        // 文件扩展名匹配
        /\.(zip|rar|7z|tar|gz|exe|msi|deb|rpm|dmg|iso|pdf|doc|docx|xls|xlsx|ppt|pptx|mp4|avi|mkv|mp3|wav)$/i,
        // URL关键词匹配
        /\/download\//i,
        /download\?/i,
        /attachment/i,
        /file\?/i,
        // GitHub Releases
        /releases\/download\//i
    ];
    
    detect(url) {
        return this.patterns.some(pattern => pattern.test(url));
    }
}
```

#### 2. UI注入模块 (UI Injector)
**职责**：在识别到的链接旁注入传输按钮

**设计考虑**：
- 使用`span`元素而非`button`，提高兼容性
- CSS样式隔离，避免与页面样式冲突
- 事件代理处理，确保动态添加的按钮正常工作

#### 3. 传输管理模块 (Transfer Manager)
**职责**：处理文件传输逻辑和状态管理

**流程设计**：
```
用户点击按钮 → 显示配置对话框 → 选择服务器 → 发起传输 → 显示进度 → 记录历史
```

### 数据存储设计

#### 服务器配置结构
```json
{
  "servers": [
    {
      "id": "uuid",
      "name": "服务器名称",
      "host": "IP或域名",
      "port": 22,
      "protocol": "sftp|ftp|scp",
      "username": "用户名",
      "password": "加密后的密码",
      "defaultPath": "/默认路径/",
      "createdAt": "ISO时间戳",
      "lastUsed": "ISO时间戳"
    }
  ]
}
```

#### 传输历史结构
```json
{
  "transferHistory": [
    {
      "id": "uuid",
      "fileName": "文件名",
      "sourceUrl": "原始链接",
      "serverId": "服务器ID",
      "targetPath": "目标路径",
      "status": "completed|failed|pending",
      "timestamp": "ISO时间戳",
      "fileSize": "文件大小(字节)",
      "duration": "传输耗时(毫秒)",
      "error": "错误信息(如果失败)"
    }
  ]
}
```

## 💻 环境配置

### 开发环境要求
```bash
# Node.js版本要求
node >= 16.0.0
npm >= 8.0.0

# 推荐的开发工具
VS Code + Extensions:
  - ES6 String HTML
  - Tailwind CSS IntelliSense
  - Prettier
  - ESLint
```

### 项目初始化
```bash
# 1. 克隆项目
git clone https://github.com/username/easy_translate.git
cd easy_translate

# 2. 安装依赖
npm install

# 3. 开发模式（热重载）
npm run dev

# 4. 生产构建
npm run build
```

### 项目结构
```
easy_translate/
├── src/                          # 源码目录
│   ├── background/               # 后台脚本
│   │   └── background.js        # 主后台逻辑
│   ├── content/                 # 内容脚本
│   │   ├── content.js          # 主内容逻辑
│   │   └── content.css         # 样式文件
│   ├── icons/                   # 图标资源
│   │   ├── icon.svg            # 矢量图标
│   │   ├── icon16.png          # 16x16像素
│   │   ├── icon32.png          # 32x32像素
│   │   ├── icon48.png          # 48x48像素
│   │   └── icon128.png         # 128x128像素
│   └── manifest.json           # 插件配置文件
├── dist/                        # 构建输出（可直接安装）
├── test/                        # 测试文件
│   └── demo.html               # 功能测试页面
├── webpack.config.js            # Webpack配置
├── tailwind.config.js           # Tailwind配置
├── postcss.config.js            # PostCSS配置
├── package.json                 # 项目配置
├── README.md                    # 用户文档
└── INSTALL.md                   # 开发指南(本文件)
```

### 构建配置说明

#### Webpack配置要点
```javascript
module.exports = {
  entry: {
    background: './src/background/background.js',
    content: './src/content/content.js'
  },
  plugins: [
    new MiniCssExtractPlugin(),      // CSS提取
    new CopyPlugin([...])            // 静态资源复制
  ]
};
```

#### Tailwind配置要点
```javascript
module.exports = {
  content: ['./src/**/*.{js,html}'], // 内容扫描路径
  plugins: [require('daisyui')],     // DaisyUI集成
  daisyui: {
    themes: ['light', 'dark']        // 主题配置
  }
};
```

## 🔧 开发工作流

### 日常开发流程
1. **启动开发模式**：`npm run dev`
2. **在浏览器中加载插件**：`edge://extensions/` → 加载 `dist` 目录
3. **修改源码**：在 `src/` 目录下进行开发
4. **测试功能**：打开 `test/demo.html` 验证功能
5. **重新加载插件**：每次修改后在扩展管理页面重新加载
6. **生产构建**：`npm run build`

### 调试技巧
```javascript
// Content Script调试
console.log('Easy Translate:', message);

// Background Script调试
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  console.log('Background received:', request);
});

// Storage调试
chrome.storage.local.get(null, (result) => {
  console.log('All storage:', result);
});
```

### 常见问题解决

#### 1. 插件无法加载
- 检查 `manifest.json` 格式
- 确保 `dist` 目录包含所有必要文件
- 查看浏览器控制台错误信息

#### 2. 样式不生效
- 确认 Tailwind CSS 正确配置
- 检查 CSS 提取插件设置
- 验证 PostCSS 处理流程

#### 3. Content Script不执行
- 检查 `content_scripts` 配置
- 确认页面匹配规则
- 查看页面控制台是否有JS错误

## 🧪 测试策略

### 单元测试
- 链接识别算法测试
- 数据存储操作测试
- UI组件渲染测试

### 集成测试
- 完整传输流程测试
- 多服务器配置测试
- 异常情况处理测试

### 用户验收测试
- 使用 `test/demo.html` 进行功能验证
- 在真实网站上测试兼容性
- 不同浏览器版本兼容性测试

## 🚀 部署发布

### 开发版本
```bash
npm run build
# 将dist目录打包为.zip文件
# 在edge://extensions/中加载
```

### 生产版本
```bash
npm run build
# 将dist目录提交到Extension Store
# 或生成.crx文件分发
```

## 📈 性能优化

### 代码优化
- 使用 Webpack 代码分割
- 启用生产模式压缩
- 移除未使用的CSS类

### 运行时优化
- 防抖处理页面变化监听
- 缓存已识别的链接
- 延迟加载非关键功能

### 存储优化
- 限制历史记录数量
- 压缩存储的配置数据
- 定期清理过期数据

---

**快速开始**：运行 `npm install && npm run dev` 开始开发！ 